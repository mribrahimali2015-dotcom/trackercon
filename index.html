<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Suit Tracker (Counts → Leads Sync) + Dashboard</title>
  <style>
    :root{ --bg:#0b0c10; --card:#12141b; --fg:#e9eef7; --muted:#a8b0c2; --border:#23283a; --soft:#0e1016; --btn:#1a1f2e; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:var(--bg); color:var(--fg); }
    header{ padding:18px; border-bottom:1px solid var(--border); background:rgba(0,0,0,.2); position:sticky; top:0; z-index:10; }
    h1{ margin:0; font-size:18px; }
    main{ max-width:1400px; margin:0 auto; padding:18px; display:grid; gap:14px; }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:14px; }
    .muted{ color:var(--muted); }
    .small{ font-size:12px; }
    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }
    input,select{ width:100%; padding:10px; border-radius:12px; border:1px solid var(--border); background:var(--soft); color:var(--fg); }
    button{ padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:var(--btn); color:var(--fg); cursor:pointer; }
    button:hover{ filter:brightness(1.08); }
    .btn-row{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; align-items:center; }
    .topline{ display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .inline{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .pill{ padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:var(--soft); color:var(--muted); font-size:12px; display:inline-block; }
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; }
    .tab{ border:1px solid var(--border); background:var(--soft); color:var(--muted); padding:8px 10px; border-radius:999px; cursor:pointer; font-size:12px; }
    .tab.active{ background:var(--btn); color:var(--fg); }
    .grid2{ display:grid; grid-template-columns:1fr; gap:14px; align-items:start; }
    @media(min-width:1100px){ .grid2{ grid-template-columns:420px 1fr; } }
    table{ width:100%; border-collapse:collapse; margin-top:10px; }
    th,td{ border-bottom:1px solid var(--border); padding:10px 8px; text-align:left; font-size:13px; vertical-align:top; }
    th{ color:var(--muted); font-weight:600; }
    .right{ text-align:right; }
    .hidden{ display:none; }
    .divider{ border:0; border-top:1px solid var(--border); margin:14px 0; }
    .mini{ padding:6px 10px; border-radius:12px; }
    .danger{ background:#2a1212; }
    .warn{ background:#2a2412; }
    .ok{ background:#102415; }

    /* KPI grid (auto wraps nicely) */
    .kpis{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:10px; }
    @media(min-width:800px){ .kpis{ grid-template-columns:repeat(7,1fr); } } /* now 7 cards */
    .kpi{ border:1px solid var(--border); border-radius:14px; padding:12px; background:var(--soft); }
    .kpi .num{ font-size:20px; font-weight:700; }
    .kpi .lbl{ font-size:12px; color:var(--muted); margin-top:4px; }

    .badge{ display:inline-block; padding:2px 8px; border:1px solid var(--border); border-radius:999px; font-size:12px; background:var(--soft); color:var(--muted); }
  </style>
</head>

<body>
<header class="topline">
  <div class="inline">
    <h1>Suit Tracker</h1>
    <span class="pill">Counts → Leads Sync</span>
  </div>

  <div class="tabs" role="tablist" aria-label="Views">
    <button class="tab active" id="tabDashboard" type="button">Dashboard</button>
    <button class="tab" id="tabCounts" type="button">Tab 1: Counts</button>
    <button class="tab" id="tabLeads" type="button">Tab 2: Leads</button>
  </div>
</header>

<main>

  <!-- ===================== DASHBOARD ===================== -->
  <section id="viewDashboard">
    <section class="card">
      <div class="topline">
        <div>
          <h2 style="margin:0;font-size:16px;">Dashboard</h2>
          <p class="muted" style="margin:6px 0 0;">
            Daily / Weekly / Monthly / Quarterly / Yearly. (Synchronised across Tab 1 + Tab 2)
          </p>
        </div>

        <div class="inline">
          <select id="d_range" aria-label="Timeframe" style="max-width:170px;">
            <option value="day">Daily</option>
            <option value="week">Weekly</option>
            <option value="month">Monthly</option>
            <option value="quarter">Quarterly</option>
            <option value="year">Yearly</option>
          </select>
          <input id="d_refDate" type="date" aria-label="Reference date" style="max-width:170px;" />

          <select id="d_attrib" aria-label="Sales attribution" style="max-width:280px;">
            <option value="served">Credit Attended/Sales to Served by</option>
            <option value="captured">Credit Attended/Sales to Captured by</option>
          </select>

          <button type="button" id="resetAll">Clear All Data</button>
        </div>
      </div>

      <div class="kpis">
        <div class="kpi"><div class="num" id="kpiNew">0</div><div class="lbl">New enquiries</div></div>
        <div class="kpi"><div class="num" id="kpiDetails">0</div><div class="lbl">Details provided</div></div>
        <div class="kpi"><div class="num" id="kpiBookedCounts">0</div><div class="lbl">Appointments booked</div></div>
        <div class="kpi"><div class="num" id="kpiAttended">0</div><div class="lbl">Appointments attended</div></div>
        <div class="kpi"><div class="num" id="kpiSales">0</div><div class="lbl">Sales (ref verified)</div></div>

        <!-- UPDATED conversion KPIs -->
        <div class="kpi"><div class="num" id="kpiDetailsToBooked">0%</div><div class="lbl">Details → Booked</div></div>
        <div class="kpi"><div class="num" id="kpiAttendedToSales">0%</div><div class="lbl">Attended → Sales</div></div>
      </div>

      <p class="muted small" style="margin:10px 0 0;">
        Notes:
        <span class="badge">Booked</span> comes from Tab 1.
        <span class="badge">Attended</span> = leads where status is <b>Attended</b>.
        <span class="badge">Sales</span> = leads where sale is <b>Yes</b> AND a valid <b>4-digit ref</b> is entered.
      </p>
    </section>

    <section class="card">
      <h2 style="margin:0;font-size:16px;">Breakdown by Source (selected timeframe)</h2>
      <table>
        <thead>
          <tr>
            <th>Source</th><th>New</th><th>Details</th><th>Booked</th><th>Attended</th><th>No-show</th><th>Cancelled</th><th>Rescheduled</th><th>Sales</th>
            <th>Details→Booked%</th><th>Attended→Sales%</th>
          </tr>
        </thead>
        <tbody id="dashBySource"></tbody>
      </table>
    </section>

    <section class="card">
      <h2 style="margin:0;font-size:16px;">Breakdown by Staff (selected timeframe)</h2>
      <p class="muted small" style="margin:6px 0 0;">
        New/Details/Booked are credited to Tab 1 staff. Attended/Sales credit uses the dropdown above (Served by or Captured by).
      </p>
      <table>
        <thead>
          <tr>
            <th>Staff</th><th>New</th><th>Details</th><th>Booked</th><th>Attended</th><th>No-show</th><th>Cancelled</th><th>Rescheduled</th><th>Sales</th>
            <th>Details→Booked%</th><th>Attended→Sales%</th>
          </tr>
        </thead>
        <tbody id="dashByStaff"></tbody>
      </table>
    </section>
  </section>

  <!-- ===================== TAB 1: COUNTS ===================== -->
  <section id="viewCounts" class="hidden">
    <section class="card">
      <div class="topline">
        <div>
          <h2 style="margin:0;font-size:16px;">Tab 1: Counts (Date + Source + Staff)</h2>
          <p class="muted" style="margin:6px 0 0;">When you increase <strong>Details provided</strong>, Tab 2 will allow more lead entries.</p>
        </div>
        <div class="inline">
          <input id="c_search" type="text" placeholder="Filter source/staff/date…" style="max-width:260px;" />
          <button type="button" id="goDash1">Go to Dashboard</button>
        </div>
      </div>
    </section>

    <section class="grid2">
      <section class="card">
        <div class="topline">
          <div>
            <h2 style="margin:0;font-size:16px;">Add / Update Counts</h2>
            <p class="muted small" style="margin:6px 0 0;">One row per <strong>Date + Source + Staff</strong>. Use Edit in the table to change.</p>
          </div>
          <span class="pill" id="countsModePill">Mode: Add</span>
        </div>

        <form id="countsForm">
          <input id="c_editKey" type="hidden" />

          <label>Date</label>
          <input id="c_date" type="date" required />

          <label>Source</label>
          <select id="c_source" required>
            <option value="">Select…</option>
            <option>Instagram</option>
            <option>TikTok</option>
            <option>Google Ads</option>
          </select>

          <label>Staff (who handled the enquiries)</label>
          <input id="c_staff" type="text" placeholder="e.g., Sam" required />

          <label>New enquiries (count)</label>
          <input id="c_new" type="number" min="0" step="1" value="0" required />

          <label>Details provided (count)</label>
          <input id="c_details" type="number" min="0" step="1" value="0" required />

          <label>Appointments booked (count)</label>
          <input id="c_booked" type="number" min="0" step="1" value="0" required />

          <div class="btn-row">
            <button type="submit" id="countsSaveBtn">Save Counts</button>
            <button type="button" id="countsCancelBtn" class="hidden">Cancel Edit</button>
          </div>

          <p class="muted small" style="margin:10px 0 0;">Rules: Details ≤ New, Booked ≤ Details.</p>
        </form>
      </section>

      <section class="card">
        <div class="topline">
          <div>
            <h2 style="margin:0;font-size:16px;">Counts Table</h2>
            <p class="muted" style="margin:6px 0 0;">Leads Entered is how many lead records exist in Tab 2 for that bucket.</p>
          </div>
          <button type="button" id="goLeadsFromCounts">Go to Tab 2</button>
        </div>

        <table>
          <thead>
            <tr>
              <th>Date</th><th>Source</th><th>Staff</th>
              <th>New</th><th>Details</th><th>Booked</th>
              <th>Leads Entered</th><th>Remaining</th>
              <th class="right"></th>
            </tr>
          </thead>
          <tbody id="countsTbody"></tbody>
        </table>
      </section>
    </section>
  </section>

  <!-- ===================== TAB 2: LEADS ===================== -->
  <section id="viewLeads" class="hidden">
    <section class="card">
      <div class="topline">
        <div>
          <h2 style="margin:0;font-size:16px;">Tab 2: Leads (Details Provided)</h2>
          <p class="muted" style="margin:6px 0 0;">Enter leads over time. Later, edit the lead to mark Attended and Sale.</p>
        </div>
        <div class="inline">
          <input id="l_search" type="text" placeholder="Search name/phone/source/staff…" style="max-width:300px;" />
          <button type="button" id="goDash2">Go to Dashboard</button>
        </div>
      </div>
    </section>

    <section class="grid2">
      <section class="card">
        <h2 style="margin:0;font-size:16px;">Add / Edit Lead</h2>

        <form id="leadForm">
          <input id="l_editId" type="hidden" />

          <label>Bucket (Date • Source • Staff)</label>
          <select id="l_bucket" required></select>

          <label>Customer name</label>
          <input id="l_name" type="text" required />

          <label>Phone number</label>
          <input id="l_phone" type="tel" required />

          <label>Appointment date (optional)</label>
          <input id="l_apptDate" type="date" />

          <label>Appointment time (optional)</label>
          <input id="l_apptTime" type="time" />

          <label>Appointment status</label>
          <select id="l_apptStatus">
            <option value="">—</option>
            <option>Scheduled</option>
            <option>Attended</option>
            <option>Cancelled</option>
            <option>Rescheduled</option>
            <option>No-show</option>
          </select>

          <label>Served by (who ran the appointment / closed the sale)</label>
          <input id="l_servedBy" type="text" placeholder="e.g., Amina" />

          <label>Sale outcome</label>
          <select id="l_sale">
            <option value="">—</option>
            <option value="Yes">Sale</option>
            <option value="No">No sale</option>
          </select>

          <label id="l_saleRefLabel">Sale reference (4 digits)</label>
          <input id="l_saleRef" type="text" inputmode="numeric" pattern="\d{4}" maxlength="4" placeholder="e.g., 4821" />
          <p class="muted small" id="l_saleRefHint" style="margin:6px 0 0;">Required only if Sale = Yes.</p>

          <div class="btn-row">
            <button type="submit" id="leadSaveBtn">Save Lead</button>
            <button type="button" id="leadCancelBtn" class="hidden">Cancel Edit</button>
            <button type="button" id="goCountsFromLeads">Go to Tab 1</button>
          </div>
        </form>
      </section>

      <section class="card">
        <div class="topline">
          <div>
            <h2 style="margin:0;font-size:16px;">Today's Appointments</h2>
            <p class="muted small" style="margin:6px 0 0;">Sorted by appointment time. Use the Status dropdown to update quickly.</p>
          </div>
          <div class="inline">
            <select id="l_staffFilter" aria-label="Staff filter" style="max-width:220px;">
              <option value="">All staff</option>
            </select>
            <button type="button" id="refreshToday" class="mini">Refresh</button>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Time</th><th>Name</th><th>Phone</th><th>Source</th>
              <th>Captured</th><th>Served</th><th>Status</th>
              <th>Sale</th><th>Ref</th><th class="right"></th>
            </tr>
          </thead>
          <tbody id="todayTbody"></tbody>
        </table>

        <hr class="divider" />

        <div class="topline">
          <div>
            <h2 style="margin:0;font-size:16px;">All Leads</h2>
            <p class="muted small" style="margin:6px 0 0;">Filter by captured date timeframe (like the Dashboard). Ordered chronologically (Appt date/time).</p>
          </div>
          <div class="inline">
            <select id="l_range" aria-label="Lead timeframe" style="max-width:170px;">
              <option value="day">Daily</option>
              <option value="week">Weekly</option>
              <option value="month" selected>Monthly</option>
              <option value="quarter">Quarterly</option>
              <option value="year">Yearly</option>
              <option value="all">All time</option>
            </select>
            <input id="l_refDate" type="date" aria-label="Lead reference date" style="max-width:170px;" />
            <span class="pill" id="l_rangePill">Monthly</span>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Date</th><th>Source</th><th>Captured By</th>
              <th>Name</th><th>Phone</th>
              <th>Appt</th><th>Status</th>
              <th>Served</th>
              <th>Sale</th><th>Ref</th>
              <th class="right"></th>
            </tr>
          </thead>
          <tbody id="leadsTbody"></tbody>
        </table>
      </section>
    </section>
  </section>

</main>

<script>
  const COUNTS_KEY = "suit_counts_v7";
  const LEADS_KEY  = "suit_leads_v7";
  const $ = (id) => document.getElementById(id);

  function todayISO(){
    const d=new Date(); const off=d.getTimezoneOffset();
    return new Date(d.getTime()-off*60000).toISOString().slice(0,10);
  }
  function load(key){ try{return JSON.parse(localStorage.getItem(key)||"[]");}catch{return [];} }
  function save(key, rows){ localStorage.setItem(key, JSON.stringify(rows)); }
  function makeId(){ return (crypto?.randomUUID) ? crypto.randomUUID() : (Date.now()+"_"+Math.random().toString(16).slice(2)); }
  function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])); }
  function clampInt(x){ const n=Number(x); if(!Number.isFinite(n)||n<0) return 0; return Math.floor(n); }
  function pct(n,d){ return (!d||d<=0) ? 0 : (n/d)*100; }

  function isValidSaleRef(ref){ return /^\d{4}$/.test(String(ref||"").trim()); }

  function updateSaleRefUI(){
    const sale = $("l_sale").value;
    const need = sale === "Yes";
    $("l_saleRef").required = need;
    $("l_saleRefLabel").style.opacity = need ? "1" : "0.6";
    $("l_saleRefHint").textContent = need ? "Required (4 digits) because Sale = Yes." : "Required only if Sale = Yes.";
    if(!need) $("l_saleRef").value = "";
  }

  function startEndForRange(range, refDateISO){
    const ref = new Date(refDateISO+"T00:00:00");
    const dayStart = new Date(ref);
    const dayEnd = new Date(ref); dayEnd.setDate(dayEnd.getDate()+1);

    if(range==="day") return [dayStart, dayEnd];
    if(range==="week"){
      const d=new Date(ref); const day=(d.getDay()+6)%7; // Mon=0
      const start=new Date(d); start.setDate(d.getDate()-day);
      const end=new Date(start); end.setDate(start.getDate()+7);
      return [start,end];
    }
    if(range==="month"){
      const start=new Date(ref.getFullYear(), ref.getMonth(), 1);
      const end=new Date(ref.getFullYear(), ref.getMonth()+1, 1);
      return [start,end];
    }
    if(range==="quarter"){
      const q=Math.floor(ref.getMonth()/3);
      const start=new Date(ref.getFullYear(), q*3, 1);
      const end=new Date(ref.getFullYear(), q*3+3, 1);
      return [start,end];
    }
    if(range==="year"){
      const start=new Date(ref.getFullYear(), 0, 1);
      const end=new Date(ref.getFullYear()+1, 0, 1);
      return [start,end];
    }
    return [dayStart, dayEnd];
  }

  function inRange(dateISO, start, end){
    const d=new Date(dateISO+"T00:00:00");
    return d>=start && d<end;
  }

  function bucketKey(date, source, staff){ return `${date}__${source}__${staff}`; }
  function getCounts(){ return load(COUNTS_KEY); }
  function getLeads(){ return load(LEADS_KEY); }

  function leadsByBucket(){
    const leads = getLeads();
    const map = {};
    for(const l of leads) map[l.bucketKey] = (map[l.bucketKey]||0) + 1;
    return map;
  }

  // Lead status helpers
  function leadIsAttended(l){ return l.apptStatus === "Attended"; }
  function leadIsNoShow(l){ return l.apptStatus === "No-show"; }
  function leadIsCancelled(l){ return l.apptStatus === "Cancelled"; }
  function leadIsRescheduled(l){ return l.apptStatus === "Rescheduled"; }
  function leadIsSale(l){ return l.sale === "Yes" && isValidSaleRef(l.saleRef); }

  function leadApptTs(l){
    const d = (l.apptDate && String(l.apptDate).trim()) ? l.apptDate : (l.dateCaptured || "");
    if(!d) return Number.MAX_SAFE_INTEGER;
    const t = (l.apptTime && /^\d{2}:\d{2}$/.test(l.apptTime)) ? l.apptTime : "23:59";
    return new Date(`${d}T${t}:00`).getTime();
  }

  function normStaff(s){ return String(s||"").trim().toLowerCase(); }

  function staffMatches(l, staffFilter){
    if(!staffFilter) return true;
    const f = normStaff(staffFilter);
    return normStaff(l.capturedBy) === f || normStaff(l.servedBy) === f;
  }

  function getStaffOptionsFromLeads(leads){
    const set = new Set();
    for(const l of leads){
      if(l.capturedBy && l.capturedBy.trim()) set.add(l.capturedBy.trim());
      if(l.servedBy && l.servedBy.trim()) set.add(l.servedBy.trim());
    }
    return Array.from(set).sort((a,b)=>a.localeCompare(b));
  }

  // ---------------- View switching ----------------
  function setView(view){
    const isDash = view==="dashboard";
    const isCounts = view==="counts";
    const isLeads = view==="leads";
    $("viewDashboard").classList.toggle("hidden", !isDash);
    $("viewCounts").classList.toggle("hidden", !isCounts);
    $("viewLeads").classList.toggle("hidden", !isLeads);

    $("tabDashboard").classList.toggle("active", isDash);
    $("tabCounts").classList.toggle("active", isCounts);
    $("tabLeads").classList.toggle("active", isLeads);

    if(isDash) renderDashboard();
    if(isCounts) renderCounts();
    if(isLeads) renderLeads();
  }

  $("tabDashboard").addEventListener("click", ()=>setView("dashboard"));
  $("tabCounts").addEventListener("click", ()=>setView("counts"));
  $("tabLeads").addEventListener("click", ()=>setView("leads"));
  $("goDash1").addEventListener("click", ()=>setView("dashboard"));
  $("goDash2").addEventListener("click", ()=>setView("dashboard"));
  $("goLeadsFromCounts").addEventListener("click", ()=>setView("leads"));
  $("goCountsFromLeads").addEventListener("click", ()=>setView("counts"));

  // ---------------- Dashboard attribution ----------------
  function staffForLead_AttendedSales(l){
    const attrib = $("d_attrib").value; // "served" | "captured"
    if(attrib === "captured") return (l.capturedBy || "—");
    return (l.servedBy && l.servedBy.trim()) ? l.servedBy.trim() : (l.capturedBy || "—");
  }

  // ---------------- Dashboard render (UPDATED %s) ----------------
  function renderDashboard(){
    const range = $("d_range").value;
    const refDate = $("d_refDate").value || todayISO();
    const [start,end] = startEndForRange(range, refDate);

    // Synchronised time filtering
    const counts = getCounts().filter(c=>inRange(c.date, start, end));
    const leads = getLeads().filter(l=>inRange(l.dateCaptured, start, end));

    const totalNew = counts.reduce((s,r)=>s+r.newEnq,0);
    const totalDetails = counts.reduce((s,r)=>s+r.details,0);
    const totalBookedCounts = counts.reduce((s,r)=>s+r.booked,0);

    const totalAttended = leads.filter(leadIsAttended).length;
    const totalSales = leads.filter(leadIsSale).length;

    $("kpiNew").textContent = totalNew;
    $("kpiDetails").textContent = totalDetails;
    $("kpiBookedCounts").textContent = totalBookedCounts;
    $("kpiAttended").textContent = totalAttended;
    $("kpiSales").textContent = totalSales;

    // NEW KPIs
    $("kpiDetailsToBooked").textContent = `${pct(totalBookedCounts, totalDetails).toFixed(1)}%`;
    $("kpiAttendedToSales").textContent = `${pct(totalSales, totalAttended).toFixed(1)}%`;

    // By Source
    const bySource = {};
    for(const c of counts){
      bySource[c.source] ??= { new:0, details:0, booked:0, attended:0, noShow:0, cancelled:0, rescheduled:0, sales:0 };
      bySource[c.source].new += c.newEnq;
      bySource[c.source].details += c.details;
      bySource[c.source].booked += c.booked;
    }
    for(const l of leads){
      bySource[l.source] ??= { new:0, details:0, booked:0, attended:0, noShow:0, cancelled:0, rescheduled:0, sales:0 };
      if(leadIsAttended(l)) bySource[l.source].attended += 1;
      if(leadIsNoShow(l)) bySource[l.source].noShow += 1;
      if(leadIsCancelled(l)) bySource[l.source].cancelled += 1;
      if(leadIsRescheduled(l)) bySource[l.source].rescheduled += 1;
      if(leadIsSale(l)) bySource[l.source].sales += 1;
    }

    const sBody = $("dashBySource");
    sBody.innerHTML = "";
    const sources = Object.keys(bySource).sort();
    if(sources.length===0){
      sBody.innerHTML = `<tr><td colspan="11" class="muted" style="padding:14px 8px;">No data in this timeframe.</td></tr>`;
    } else {
      for(const s of sources){
        const t = bySource[s];
        sBody.innerHTML += `
          <tr>
            <td>${escapeHtml(s)}</td>
            <td>${t.new}</td>
            <td>${t.details}</td>
            <td>${t.booked}</td>
            <td>${t.attended}</td>
            <td>${t.noShow}</td>
            <td>${t.cancelled}</td>
            <td>${t.rescheduled}</td>
            <td>${t.sales}</td>
            <td>${pct(t.booked, t.details).toFixed(1)}%</td>
            <td>${pct(t.sales, t.attended).toFixed(1)}%</td>
          </tr>
        `;
      }
    }

    // By Staff
    const byStaff = {};
    // Tab 1 staff credit for New/Details/Booked
    for(const c of counts){
      byStaff[c.staff] ??= { new:0, details:0, booked:0, attended:0, noShow:0, cancelled:0, rescheduled:0, sales:0 };
      byStaff[c.staff].new += c.newEnq;
      byStaff[c.staff].details += c.details;
      byStaff[c.staff].booked += c.booked;
    }
    // Attended/Sales credit via attribution dropdown
    for(const l of leads){
      const staff = staffForLead_AttendedSales(l);
      byStaff[staff] ??= { new:0, details:0, booked:0, attended:0, noShow:0, cancelled:0, rescheduled:0, sales:0 };
      if(leadIsAttended(l)) byStaff[staff].attended += 1;
      if(leadIsNoShow(l)) byStaff[staff].noShow += 1;
      if(leadIsCancelled(l)) byStaff[staff].cancelled += 1;
      if(leadIsRescheduled(l)) byStaff[staff].rescheduled += 1;
      if(leadIsSale(l)) byStaff[staff].sales += 1;
    }

    const stBody = $("dashByStaff");
    stBody.innerHTML = "";
    const staffKeys = Object.keys(byStaff).sort();
    if(staffKeys.length===0){
      stBody.innerHTML = `<tr><td colspan="11" class="muted" style="padding:14px 8px;">No data in this timeframe.</td></tr>`;
    } else {
      for(const s of staffKeys){
        const t = byStaff[s];
        stBody.innerHTML += `
          <tr>
            <td>${escapeHtml(s)}</td>
            <td>${t.new}</td>
            <td>${t.details}</td>
            <td>${t.booked}</td>
            <td>${t.attended}</td>
            <td>${t.noShow}</td>
            <td>${t.cancelled}</td>
            <td>${t.rescheduled}</td>
            <td>${t.sales}</td>
            <td>${pct(t.booked, t.details).toFixed(1)}%</td>
            <td>${pct(t.sales, t.attended).toFixed(1)}%</td>
          </tr>
        `;
      }
    }
  }

  $("d_range").addEventListener("change", renderDashboard);
  $("d_refDate").addEventListener("change", renderDashboard);
  $("d_attrib").addEventListener("change", renderDashboard);

  // ---------------- Counts ----------------
  function setCountsMode(mode){
    const editing = mode==="edit";
    $("countsModePill").textContent = editing ? "Mode: Edit" : "Mode: Add";
    $("countsCancelBtn").classList.toggle("hidden", !editing);
    $("countsSaveBtn").textContent = editing ? "Save Changes" : "Save Counts";
  }

  function resetCountsForm(){
    $("c_editKey").value = "";
    $("c_date").value = todayISO();
    $("c_source").value = "";
    $("c_staff").value = "";
    $("c_new").value = 0;
    $("c_details").value = 0;
    $("c_booked").value = 0;
    setCountsMode("add");
  }

  function openCountsEdit(row){
    $("c_editKey").value = row.key;
    $("c_date").value = row.date;
    $("c_source").value = row.source;
    $("c_staff").value = row.staff;
    $("c_new").value = row.newEnq;
    $("c_details").value = row.details;
    $("c_booked").value = row.booked;
    setCountsMode("edit");
  }

  $("countsCancelBtn").addEventListener("click", resetCountsForm);

  function refreshBucketDropdown(preselectKey=null){
    const sel = $("l_bucket");
    if(!sel) return;

    const counts = getCounts();
    const leadCount = leadsByBucket();
    const bucketsAll = counts
      .filter(c=>c.details>0)
      .map(c=>{
        const entered = leadCount[c.key] || 0;
        const remaining = Math.max(0, c.details - entered);
        return { key:c.key, date:c.date, source:c.source, staff:c.staff, details:c.details, entered, remaining };
      });

    const remaining = bucketsAll.filter(b=>b.remaining>0);

    const editingId = $("l_editId")?.value?.trim();
    const editingLead = editingId ? getLeads().find(l=>l.id===editingId) : null;
    const mustIncludeKey = editingLead?.bucketKey || null;

    const options = [...remaining];
    if(mustIncludeKey && !options.some(b=>b.key===mustIncludeKey)){
      const found = bucketsAll.find(b=>b.key===mustIncludeKey);
      if(found) options.push(found);
    }

    sel.innerHTML = "";
    if(options.length===0){
      sel.innerHTML = `<option value="">No available buckets (increase Details in Tab 1)</option>`;
      sel.disabled = true;
      return;
    }
    sel.disabled = false;

    options.sort((a,b)=> (a.date<b.date ? 1 : (a.date>b.date ? -1 : a.source.localeCompare(b.source))));
    for(const b of options){
      const label = `${b.date} • ${b.source} • ${b.staff}  (remaining: ${b.remaining})`;
      const opt = document.createElement("option");
      opt.value = b.key;
      opt.textContent = label;
      sel.appendChild(opt);
    }
    if(preselectKey && [...sel.options].some(o=>o.value===preselectKey)) sel.value = preselectKey;
  }

  function renderCounts(){
    const q = ($("c_search").value||"").toLowerCase().trim();
    const counts = getCounts();
    const tbody = $("countsTbody");
    tbody.innerHTML = "";
    const leadCount = leadsByBucket();

    const filtered = counts
      .filter(c=>{
        if(!q) return true;
        return (c.date||"").includes(q) ||
               (c.source||"").toLowerCase().includes(q) ||
               (c.staff||"").toLowerCase().includes(q);
      })
      .sort((a,b)=> (a.date<b.date ? 1 : -1));

    if(filtered.length===0){
      tbody.innerHTML = `<tr><td colspan="9" class="muted" style="padding:14px 8px;">No rows yet.</td></tr>`;
      refreshBucketDropdown();
      return;
    }

    for(const c of filtered){
      const entered = leadCount[c.key] || 0;
      const remaining = Math.max(0, c.details - entered);

      tbody.innerHTML += `
        <tr>
          <td>${c.date}</td>
          <td>${escapeHtml(c.source)}</td>
          <td>${escapeHtml(c.staff)}</td>
          <td>${c.newEnq}</td>
          <td>${c.details}</td>
          <td>${c.booked}</td>
          <td>${entered}</td>
          <td>${remaining}</td>
          <td class="right" style="white-space:nowrap; display:flex; gap:8px; justify-content:flex-end;">
            <button type="button" class="c_edit mini" data-key="${escapeHtml(c.key)}">Edit</button>
            <button type="button" class="c_del mini danger" data-key="${escapeHtml(c.key)}">Delete</button>
          </td>
        </tr>
      `;
    }

    tbody.querySelectorAll(".c_edit").forEach(btn=>{
      btn.onclick=()=>{
        const key = btn.getAttribute("data-key");
        const row = getCounts().find(c=>c.key===key);
        if(row) openCountsEdit(row);
      };
    });

    tbody.querySelectorAll(".c_del").forEach(btn=>{
      btn.onclick=()=>{
        const key = btn.getAttribute("data-key");
        save(COUNTS_KEY, getCounts().filter(c=>c.key!==key));
        if($("c_editKey").value === key) resetCountsForm();
        renderCounts(); renderLeads(); renderDashboard();
      };
    });

    refreshBucketDropdown();
  }

  $("countsForm").addEventListener("submit",(e)=>{
    e.preventDefault();
    const date = $("c_date").value;
    const source = $("c_source").value;
    const staff = $("c_staff").value.trim();

    const newEnq = clampInt($("c_new").value);
    const details = clampInt($("c_details").value);
    const booked = clampInt($("c_booked").value);

    if(details > newEnq) return alert("Details provided cannot be higher than New enquiries.");
    if(booked > details) return alert("Appointments booked cannot be higher than Details provided.");

    const existingEditKey = $("c_editKey").value.trim();
    const newKey = bucketKey(date, source, staff);
    const rows = getCounts();

    if(existingEditKey && existingEditKey !== newKey){
      if(rows.some(r=>r.key===newKey)) return alert("A counts row already exists for that Date + Source + Staff.");
      const idx = rows.findIndex(r=>r.key===existingEditKey);
      if(idx !== -1){
        rows[idx] = { key:newKey, date, source, staff, newEnq, details, booked };
        const leads = getLeads().map(l => (l.bucketKey === existingEditKey)
          ? ({ ...l, bucketKey:newKey, dateCaptured:date, source, capturedBy:staff })
          : l
        );
        save(LEADS_KEY, leads);
      }
      save(COUNTS_KEY, rows);
      resetCountsForm();
      renderCounts(); renderLeads(); renderDashboard();
      return;
    }

    const key = newKey;
    const idx = rows.findIndex(r=>r.key===key);
    const row = { key, date, source, staff, newEnq, details, booked };
    if(idx === -1) rows.push(row); else rows[idx] = row;

    save(COUNTS_KEY, rows);
    resetCountsForm();
    renderCounts(); renderLeads(); renderDashboard();
  });

  $("c_search").addEventListener("input", renderCounts);

  // ---------------- Leads ----------------
  function setLeadMode(mode){
    const editing = mode==="edit";
    $("leadCancelBtn").classList.toggle("hidden", !editing);
    $("leadSaveBtn").textContent = editing ? "Save Changes" : "Save Lead";
  }

  function resetLeadForm(){
    $("l_editId").value = "";
    $("l_name").value = "";
    $("l_phone").value = "";
    $("l_apptDate").value = "";
    $("l_apptTime").value = "";
    $("l_apptStatus").value = "";
    $("l_servedBy").value = "";
    $("l_sale").value = "";
    $("l_saleRef").value = "";
    setLeadMode("add");
    refreshBucketDropdown();
    updateSaleRefUI();
  }

  $("leadCancelBtn").addEventListener("click", resetLeadForm);
  $("l_sale").addEventListener("change", updateSaleRefUI);

  function openLeadEdit(lead){
    $("l_editId").value = lead.id;
    refreshBucketDropdown(lead.bucketKey);
    $("l_bucket").value = lead.bucketKey;

    $("l_name").value = lead.name || "";
    $("l_phone").value = lead.phone || "";
    $("l_apptDate").value = lead.apptDate || "";
    $("l_apptTime").value = lead.apptTime || "";
    $("l_apptStatus").value = lead.apptStatus || "";
    $("l_servedBy").value = lead.servedBy || "";
    $("l_sale").value = lead.sale || "";
    $("l_saleRef").value = lead.saleRef || "";

    setLeadMode("edit");
    updateSaleRefUI();
  }

  
  function renderLeads(){
    refreshBucketDropdown();

    const allLeads = getLeads();

    // Lead timeframe (filters by captured date, like the Dashboard)
    const leadRangeSel = $("l_range");
    const leadRefInput = $("l_refDate");
    const leadRangePill = $("l_rangePill");
    const leadRange = leadRangeSel ? leadRangeSel.value : "month";
    const leadRefDate = (leadRefInput && leadRefInput.value) ? leadRefInput.value : todayISO();

    let leadStart=null, leadEnd=null;
    if(leadRange !== "all"){
      [leadStart, leadEnd] = startEndForRange(leadRange, leadRefDate);
    }

    if(leadRangePill && leadRangeSel){
      leadRangePill.textContent = leadRangeSel.options[leadRangeSel.selectedIndex]?.text || "";
    }
    if(leadRefInput){
      const all = leadRange === "all";
      leadRefInput.disabled = all;
      leadRefInput.style.opacity = all ? "0.55" : "1";
      if(all && leadRangePill) leadRangePill.textContent = "All time";
    }
    const staffList = getStaffOptionsFromLeads(allLeads);

    const staffSelect = $("l_staffFilter");
    if(staffSelect){
      const prev = staffSelect.value;
      staffSelect.innerHTML = `<option value="">All staff</option>` + staffList.map(s=>`<option>${escapeHtml(s)}</option>`).join("");
      // try keep selection
      if(prev && staffList.includes(prev)) staffSelect.value = prev;
    }

    const staffFilter = (staffSelect && staffSelect.value) ? staffSelect.value.trim() : "";

    // ---------- Today's appointments ----------
    const today = todayISO();
    const todays = allLeads
      .filter(l=>l.apptDate === today)
      .filter(l=>staffMatches(l, staffFilter))
      .sort((a,b)=> leadApptTs(a) - leadApptTs(b));

    const tBody = $("todayTbody");
    if(tBody){
      tBody.innerHTML = "";
      if(todays.length===0){
        tBody.innerHTML = `<tr><td colspan="10" class="muted" style="padding:14px 8px;">No appointments scheduled for today.</td></tr>`;
      } else {
        for(const l of todays){
          const time = l.apptTime ? l.apptTime : "—";
          const servedOptions = `<option value="" ${!l.servedBy ? "selected" : ""}>—</option>` + staffList.map(s=>`<option ${l.servedBy===s ? "selected" : ""}>${escapeHtml(s)}</option>`).join("");
          tBody.innerHTML += `
            <tr>
              <td>${escapeHtml(time)}</td>
              <td>${escapeHtml(l.name)}</td>
              <td>${escapeHtml(l.phone)}</td>
              <td>${escapeHtml(l.source)}</td>
              <td>${escapeHtml(l.capturedBy)}</td>
              <td>
                <select class="today_served" data-id="${escapeHtml(l.id)}" style="min-width:140px;">
                  ${servedOptions}
                </select>
              </td>
              <td>
                <select class="today_status" data-id="${escapeHtml(l.id)}" style="min-width:140px;">
                  <option value="" ${!l.apptStatus ? "selected" : ""}>—</option>
                  <option ${l.apptStatus==="Scheduled" ? "selected" : ""}>Scheduled</option>
                  <option ${l.apptStatus==="Attended" ? "selected" : ""}>Attended</option>
                  <option ${l.apptStatus==="Cancelled" ? "selected" : ""}>Cancelled</option>
                  <option ${l.apptStatus==="Rescheduled" ? "selected" : ""}>Rescheduled</option>
                  <option ${l.apptStatus==="No-show" ? "selected" : ""}>No-show</option>
                </select>
              </td>
              <td><span class="pill ${l.sale==="Yes" ? "ok" : (l.sale==="No" ? "danger" : "")}">${escapeHtml(l.sale || "—")}</span></td>
              <td>${escapeHtml(l.saleRef || "—")}</td>
              <td class="right" style="white-space:nowrap;">
                <button type="button" class="l_edit mini" data-id="${escapeHtml(l.id)}">Edit</button>
              </td>
            </tr>
          `;
        }

        tBody.querySelectorAll(".today_status").forEach(sel=>{
          sel.onchange = ()=>{
            const id = sel.getAttribute("data-id");
            const leads = getLeads();
            const idx = leads.findIndex(x=>x.id===id);
            if(idx>=0){
              leads[idx].apptStatus = sel.value;
              save(LEADS_KEY, leads);
              renderDashboard(); // keep KPIs in sync
            }
          };
        });


        tBody.querySelectorAll(".today_served").forEach(sel=>{
          sel.onchange = ()=>{
            const id = sel.getAttribute("data-id");
            const leads = getLeads();
            const idx = leads.findIndex(x=>x.id===id);
            if(idx>=0){
              leads[idx].servedBy = sel.value;
              save(LEADS_KEY, leads);
              renderDashboard();
              renderLeads(); // keep list filters/options fresh
            }
          };
        });

        tBody.querySelectorAll(".l_edit").forEach(btn=>{
          btn.onclick=()=>{
            const id = btn.getAttribute("data-id");
            const lead = getLeads().find(l=>l.id===id);
            if(lead) openLeadEdit(lead);
          };
        });
      }
    }

    // ---------- All leads (chronological) ----------
    const q = ($("l_search").value||"").toLowerCase().trim();

    const leads = allLeads
      .filter(l=> (leadRange === "all") ? true : inRange(l.dateCaptured, leadStart, leadEnd))
      .filter(l=>staffMatches(l, staffFilter))
      .filter(l=>{
        if(!q) return true;
        return (l.name||"").toLowerCase().includes(q) ||
               (l.phone||"").toLowerCase().includes(q) ||
               (l.source||"").toLowerCase().includes(q) ||
               (l.capturedBy||"").toLowerCase().includes(q) ||
               (l.servedBy||"").toLowerCase().includes(q) ||
               (l.saleRef||"").toLowerCase().includes(q);
      })
      .sort((a,b)=> leadApptTs(a) - leadApptTs(b));

    const tbody = $("leadsTbody");
    tbody.innerHTML = "";

    if(leads.length===0){
      tbody.innerHTML = `<tr><td colspan="11" class="muted" style="padding:14px 8px;">No leads entered yet.</td></tr>`;
      return;
    }

    for(const l of leads){
      const appt = (l.apptDate ? l.apptDate : "") + (l.apptTime ? ` ${l.apptTime}` : "");
      const servedOptions = `<option value="" ${!l.servedBy ? "selected" : ""}>—</option>` + staffList.map(s=>`<option ${l.servedBy===s ? "selected" : ""}>${escapeHtml(s)}</option>`).join("");
      tbody.innerHTML += `
        <tr>
          <td>${l.dateCaptured}</td>
          <td>${escapeHtml(l.source)}</td>
          <td>${escapeHtml(l.capturedBy)}</td>
          <td>${escapeHtml(l.name)}</td>
          <td>${escapeHtml(l.phone)}</td>
          <td>${escapeHtml(appt.trim() || "—")}</td>
          <td><span class="pill ${l.apptStatus ? "warn" : ""}">${escapeHtml(l.apptStatus || "—")}</span></td>
          <td>
            <select class="lead_served" data-id="${escapeHtml(l.id)}" style="min-width:140px;">
              ${servedOptions}
            </select>
          </td>
          <td><span class="pill ${l.sale==="Yes" ? "ok" : (l.sale==="No" ? "danger" : "")}">${escapeHtml(l.sale || "—")}</span></td>
          <td>${escapeHtml(l.saleRef || "—")}</td>
          <td class="right" style="white-space:nowrap; display:flex; gap:8px; justify-content:flex-end;">
            <button type="button" class="l_edit mini" data-id="${escapeHtml(l.id)}">Edit</button>
            <button type="button" class="l_del mini danger" data-id="${escapeHtml(l.id)}">Delete</button>
          </td>
        </tr>
      `;
    }


    tbody.querySelectorAll(".lead_served").forEach(sel=>{
      sel.onchange = ()=>{
        const id = sel.getAttribute("data-id");
        const leads = getLeads();
        const idx = leads.findIndex(x=>x.id===id);
        if(idx>=0){
          leads[idx].servedBy = sel.value;
          save(LEADS_KEY, leads);
          renderDashboard();
          // keep staff filter options consistent
          renderLeads();
        }
      };
    });

    tbody.querySelectorAll(".l_edit").forEach(btn=>{
      btn.onclick=()=>{
        const id = btn.getAttribute("data-id");
        const lead = getLeads().find(l=>l.id===id);
        if(lead) openLeadEdit(lead);
      };
    });

    tbody.querySelectorAll(".l_del").forEach(btn=>{
      btn.onclick=()=>{
        const id = btn.getAttribute("data-id");
        save(LEADS_KEY, getLeads().filter(l=>l.id!==id));
        if($("l_editId").value === id) resetLeadForm();
        renderLeads(); renderCounts(); renderDashboard();
      };
    });
  }


  $("leadForm").addEventListener("submit",(e)=>{
    e.preventDefault();

    const leads = getLeads();
    const editingId = $("l_editId").value.trim();
    const isEdit = !!editingId;

    const chosenBucketKey = $("l_bucket").value;
    if(!chosenBucketKey) return alert("No available bucket. Increase Details Provided in Tab 1 first.");

    const countsRow = getCounts().find(c=>c.key===chosenBucketKey);
    if(!countsRow) return alert("Bucket not found in counts (Tab 1).");

    const leadCount = leadsByBucket();
    const enteredInBucket = leadCount[chosenBucketKey] || 0;
    const allowed = countsRow.details;

    if(!isEdit){
      if(enteredInBucket >= allowed) return alert("This bucket is full. Increase Details Provided in Tab 1.");
    } else {
      const current = leads.find(l=>l.id===editingId);
      if(!current) return alert("Lead not found.");
      const changedBucket = current.bucketKey !== chosenBucketKey;
      if(changedBucket){
        const enteredNewBucket = (leadCount[chosenBucketKey] || 0);
        if(enteredNewBucket >= allowed) return alert("New bucket is full. Increase Details Provided in Tab 1.");
      }
    }

    const name = $("l_name").value.trim();
    const phone = $("l_phone").value.trim();
    const apptDate = $("l_apptDate").value;
    const apptTime = $("l_apptTime").value;
    let apptStatus = $("l_apptStatus").value;
    if((apptDate || apptTime) && !apptStatus) apptStatus = "Scheduled";

    const servedBy = $("l_servedBy").value.trim();
    const sale = $("l_sale").value;
    const saleRef = $("l_saleRef").value.trim();

    if(sale === "Yes" && !isValidSaleRef(saleRef)){
      return alert("Sale reference must be exactly 4 digits (e.g., 4821).");
    }

    if(!isEdit){
      leads.push({
        id: makeId(),
        createdAt: Date.now(),
        bucketKey: chosenBucketKey,
        dateCaptured: countsRow.date,
        source: countsRow.source,
        capturedBy: countsRow.staff,
        name, phone,
        apptDate, apptTime, apptStatus,
        servedBy,
        sale,
        saleRef
      });
      save(LEADS_KEY, leads);
      resetLeadForm();
    } else {
      const idx = leads.findIndex(l=>l.id===editingId);
      const prev = leads[idx];
      leads[idx] = {
        ...prev,
        bucketKey: chosenBucketKey,
        dateCaptured: countsRow.date,
        source: countsRow.source,
        capturedBy: countsRow.staff,
        name, phone,
        apptDate, apptTime, apptStatus,
        servedBy,
        sale,
        saleRef
      };
      save(LEADS_KEY, leads);
      resetLeadForm();
    }

    renderLeads(); renderCounts(); renderDashboard();
  });

  $("l_search").addEventListener("input", renderLeads);
  $("l_staffFilter").addEventListener("change", renderLeads);
  $("refreshToday").addEventListener("click", renderLeads);
  $("l_range").addEventListener("change", renderLeads);
  $("l_refDate").addEventListener("change", renderLeads);


  // ---------------- Clear All ----------------
  $("resetAll").addEventListener("click", ()=>{
    if(!confirm("Clear ALL counts + leads from this browser?")) return;
    localStorage.removeItem(COUNTS_KEY);
    localStorage.removeItem(LEADS_KEY);
    resetCountsForm();
    resetLeadForm();
    renderDashboard(); renderCounts(); renderLeads();
  });

  // ---------------- Init ----------------
  $("d_refDate").value = todayISO();
  $("c_date").value = todayISO();
  $("l_refDate").value = todayISO();
  $("d_attrib").value = "served";
  resetCountsForm();
  resetLeadForm();
  updateSaleRefUI();
  setView("dashboard");
</script>
</body>
</html>
